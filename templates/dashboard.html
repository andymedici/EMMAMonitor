<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMMA Municipal Bond Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e4080 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .section-content {
            padding: 1.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #2c5aa0;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e4080;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .queries-list {
            margin-top: 1rem;
        }
        
        .query-item {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        
        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .query-name {
            font-weight: 600;
            color: #2c5aa0;
        }
        
        .query-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .query-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .query-emails {
            background: #e3f2fd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .query-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .matches-list {
            margin-top: 1rem;
        }
        
        .match-item {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        
        .match-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .match-title a {
            color: #2c5aa0;
            text-decoration: none;
        }
        
        .match-title a:hover {
            text-decoration: underline;
        }
        
        .match-meta {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .match-keywords {
            background: #fff3cd;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .relevance-score {
            background: #28a745;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .edit-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 2px solid #2c5aa0;
        }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .real-time-indicator {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.85rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .data-source {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .data-source h4 {
            margin-bottom: 0.5rem;
            color: #856404;
        }
        
        .help-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .query-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .query-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>EMMA Municipal Bond Monitor</h1>
        <p>Real-time monitoring of EMMA municipal bond disclosures with custom email alerts</p>
        <div class="connection-status" style="margin-top: 1rem;">
            <div class="status-dot"></div>
            <span>Connected to EMMA Database</span>
            <span class="real-time-indicator">Live Data</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Data Source Information -->
        <div class="data-source">
            <h4>Real EMMA Data Source</h4>
            <p>This system connects directly to the official EMMA (Electronic Municipal Market Access) database maintained by the MSRB. All municipal bond disclosures, financial reports, and material event notices are fetched in real-time from emma.msrb.org.</p>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_matches }}</div>
                <div class="stat-label">Recent Matches</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.active_queries }}</div>
                <div class="stat-label">Active Queries</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_documents }}</div>
                <div class="stat-label">Documents Scanned</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ batches|length }}</div>
                <div class="stat-label">Query Batches</div>
            </div>
        </div>
        
        <!-- Add New Search Query Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Add New Search Query</h2>
                <span style="color: #666; font-size: 0.85rem;">Real-time EMMA monitoring</span>
            </div>
            <div class="section-content">
                <form action="/queries" method="post">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Query Name</label>
                            <input type="text" id="name" name="name" required 
                                   placeholder="e.g., 'Default Risk Monitoring'">
                            <div class="help-text">Give your search query a descriptive name</div>
                        </div>
                        <div class="form-group">
                            <label for="search_type">Search Type</label>
                            <select id="search_type" name="search_type" required>
                                <option value="exact">Exact Match</option>
                                <option value="all">All Terms (AND)</option>
                                <option value="any">Any Terms (OR)</option>
                            </select>
                            <div class="help-text">How to match your search terms in documents</div>
                        </div>
                        <div class="form-group">
                            <label for="batch_name">Batch Name (Optional)</label>
                            <input type="text" id="batch_name" name="batch_name" 
                                   placeholder="e.g., 'Credit Risk', 'Budget Analysis'">
                            <div class="help-text">Group related queries together</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="query">Search Terms</label>
                        <input type="text" id="query" name="query" required 
                               placeholder="e.g., 'default, bankruptcy' or 'budget amendment'">
                        <div class="help-text">
                            <strong>Exact Match:</strong> Find the exact phrase | 
                            <strong>All Terms:</strong> Document must contain ALL terms (separate with commas) | 
                            <strong>Any Terms:</strong> Document contains ANY of the terms (separate with commas)
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="alert_emails">Custom Alert Emails</label>
                        <input type="text" id="alert_emails" name="alert_emails" 
                               placeholder="email1@example.com, email2@example.com">
                        <div class="help-text">
                            Enter email addresses separated by commas. These people will receive alerts when this specific query finds matches in EMMA disclosures.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Search Query</button>
                </form>
            </div>
        </div>
        
        <!-- Current Search Queries Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Current Search Queries ({{ search_queries|length }})</h2>
                <div class="actions-bar">
                    <form action="/scan" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-success">Run Manual Scan</button>
                    </form>
                </div>
            </div>
            <div class="section-content">
                {% if search_queries %}
                    <div class="queries-list">
                        {% for query in search_queries %}
                        <div class="query-item">
                            <div class="query-header">
                                <span class="query-name">{{ query.name }}</span>
                                <span class="query-status {{ 'status-active' if query.active else 'status-inactive' }}">
                                    {{ 'Active' if query.active else 'Inactive' }}
                                </span>
                            </div>
                            <div class="query-details">
                                <strong>Type:</strong> {{ query.search_type|title }} | 
                                <strong>Terms:</strong> "{{ query.query }}"
                                {% if query.batch_name %}
                                | <strong>Batch:</strong> {{ query.batch_name }}
                                {% endif %}
                            </div>
                            {% if query.alert_emails %}
                            <div class="query-emails">
                                <strong>Custom Alerts:</strong> {{ query.alert_emails }}
                            </div>
                            {% endif %}
                            <div class="query-actions">
                                <button onclick="toggleEdit({{ query.id }})" class="btn btn-secondary btn-sm">
                                    Edit
                                </button>
                                <form action="/queries/{{ query.id }}/delete" method="post" style="display: inline;"
                                      onsubmit="return confirm('Are you sure you want to delete this query?')">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                            
                            <!-- Edit Form (Hidden by default) -->
                            <div id="edit-{{ query.id }}" class="edit-form">
                                <h4>Edit Query: {{ query.name }}</h4>
                                <form action="/queries/{{ query.id }}/update" method="post">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="edit_name_{{ query.id }}">Query Name</label>
                                            <input type="text" id="edit_name_{{ query.id }}" name="name" 
                                                   value="{{ query.name }}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit_search_type_{{ query.id }}">Search Type</label>
                                            <select id="edit_search_type_{{ query.id }}" name="search_type" required>
                                                <option value="exact" {{ 'selected' if query.search_type == 'exact' }}>Exact Match</option>
                                                <option value="all" {{ 'selected' if query.search_type == 'all' }}>All Terms (AND)</option>
                                                <option value="any" {{ 'selected' if query.search_type == 'any' }}>Any Terms (OR)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="edit_batch_name_{{ query.id }}">Batch Name</label>
                                            <input type="text" id="edit_batch_name_{{ query.id }}" name="batch_name" 
                                                   value="{{ query.batch_name }}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_query_{{ query.id }}">Search Terms</label>
                                        <input type="text" id="edit_query_{{ query.id }}" name="query" 
                                               value="{{ query.query }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_alert_emails_{{ query.id }}">Custom Alert Emails</label>
                                        <input type="text" id="edit_alert_emails_{{ query.id }}" name="alert_emails" 
                                               value="{{ query.alert_emails }}">
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="active" {{ 'checked' if query.active }}> 
                                            Active
                                        </label>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button type="submit" class="btn btn-primary">Update Query</button>
                                        <button type="button" onclick="toggleEdit({{ query.id }})" class="btn btn-secondary">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No search queries configured yet. Add your first search query above to start monitoring real-time EMMA municipal bond disclosures.
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Matches Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Recent Matches from EMMA ({{ matches|length }})</h2>
                <span style="color: #666; font-size: 0.85rem;">Live data from emma.msrb.org</span>
            </div>
            <div class="section-content">
                {% if matches %}
                    <div class="matches-list">
                        {% for match in matches %}
                        <div class="match-item">
                            <div class="match-title">
                                <a href="{{ match.url }}" target="_blank">{{ match.title }}</a>
                                {% if match.relevance_score %}
                                <span class="relevance-score">{{ match.relevance_score }}% relevance</span>
                                {% endif %}
                            </div>
                            <div class="match-meta">
                                <strong>Published:</strong> {{ match.pub_date }} | 
                                <strong>Matched Queries:</strong> {{ match.matched_searches|join(', ') }}
                                {% if match.issuer_name %}
                                | <strong>Issuer:</strong> {{ match.issuer_name }}
                                {% endif %}
                                {% if match.document_type %}
                                | <strong>Type:</strong> {{ match.document_type }}
                                {% endif %}
                                {% if match.file_size_kb %}
                                | <strong>Size:</strong> {{ match.file_size_kb }}KB
                                {% endif %}
                            </div>
                            {% if match.matched_terms %}
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Keywords Found:</strong>
                                {% for term in match.matched_terms %}
                                <span class="match-keywords">{{ term }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if match.pages_with_matches %}
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Found on pages:</strong> {{ match.pages_with_matches|join(', ') }}
                            </div>
                            {% endif %}
                            {% if match.alert_emails %}
                            <div style="font-size: 0.8rem; color: #666;">
                                <strong>Alerts sent to:</strong> {{ match.alert_emails|join(', ') }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No matches found yet. When your search queries find relevant municipal bond disclosures in the EMMA database, they will appear here with real-time alerts sent to your specified email addresses.
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- System Status -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">System Status</h2>
            </div>
            <div class="section-content">
                <div class="alert alert-success">
                    <strong>EMMA Connection:</strong> Active and connected to real EMMA database (emma.msrb.org)<br>
                    <strong>Data Source:</strong> Official MSRB Electronic Municipal Market Access system<br>
                    <strong>Update Frequency:</strong> Real-time scanning with enhanced session management<br>
                    <strong>Document Processing:</strong> Full PDF text extraction with page-level matching
                </div>
                <p style="color: #666; font-size: 0.9rem; margin-top: 1rem;">
                    The system automatically scans EMMA for new municipal bond disclosures daily at 9 AM, with background processing at 2 AM and 2 PM. 
                    All documents are fetched directly from the official EMMA database and processed for your search terms with precise page-level matching.
                </p>
            </div>
        </div>
    </div>
    
    <script>
        function toggleEdit(queryId) {
            const editForm = document.getElementById('edit-' + queryId);
            if (editForm.style.display === 'none' || editForm.style.display === '') {
                editForm.style.display = 'block';
            } else {
                editForm.style.display = 'none';
            }
        }
        
        // Auto-refresh the page every 5 minutes to show new matches
        setTimeout(function() {
            location.reload();
        }, 300000); // 5 minutes
        
        // Show loading state when forms are submitted
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Processing...';
                    submitBtn.disabled = true;
                }
            });
        });
    </script>
</body>
</html>
